import 'dart:io';
import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'package:window_manager/window_manager.dart';
import '../services/u2net_service.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/services.dart' show rootBundle;
import '../services/inference_isolate.dart';

class BackgroundRemoverScreen extends StatefulWidget {
  final String Function(String key, {String? fallback}) getText;
  const BackgroundRemoverScreen({super.key, required this.getText});

  @override
  State<BackgroundRemoverScreen> createState() => _BackgroundRemoverScreenState();
}

class _BackgroundRemoverScreenState extends State<BackgroundRemoverScreen> {
  File? _selectedImage;
  Uint8List? _resultImage;
  bool _processing = false;
  final U2NetService _u2net = U2NetService();
  bool _modelLoaded = false;

  Future<void> _pickImage() async {
    try {
      final picker = ImagePicker();
      final picked = await picker.pickImage(source: ImageSource.gallery);
      if (picked != null) {
        setState(() {
          _selectedImage = File(picked.path);
          _resultImage = null;
        });
      }
    } catch (e) {
      debugPrint('[ImagePicker] error: $e');
    }
  }

  Future<void> _removeBackgroundLocally() async {
    if (_selectedImage == null) return;

    // Evitar reentradas
    if (_processing == true) return;
    setState(() => _processing = true);

    try {
      // Asegurarse de tener model bytes cargados (cargados en initState)
      if (_modelBytes == null) {
        debugPrint('[RemoveBG] model bytes not loaded, loading now...');
        try {
          final ByteData data = await rootBundle.load('assets/models/u2net.tflite');
          _modelBytes = data.buffer.asUint8List();
        } catch (e) {
          debugPrint('[RemoveBG] failed to load model asset: $e');
          setState(() => _processing = false);
          return;
        }
      }

      // Leer bytes de la imagen seleccionada
      final Uint8List imageBytes = await _selectedImage!.readAsBytes();

      // Ejecutar la inferencia en otro isolate con compute
      final Uint8List resultPng = await compute(
        runRemoveBgInIsolate,
        IsolateArgs(imageBytes, _modelBytes!),
      );

      // Guardar resultado en el estado para mostrar en UI
      setState(() {
        _resultImage = resultPng;
      });
    } catch (e, st) {
      debugPrint('[RemoveBG] error: $e\n$st');
      // Opcional: mostrar SnackBar o diÃ¡logo con error
    } finally {
      // Terminar indicador de procesamiento
      if (mounted) setState(() => _processing = false);
    }
  }


  Widget _buildTitleBar() {
    final get = widget.getText;
    return GestureDetector(
      behavior: HitTestBehavior.translucent,
      onPanStart: (_) => windowManager.startDragging(),
      child: Container(
        height: 42,
        padding: const EdgeInsets.symmetric(horizontal: 10),
        child: Row(
          children: [
            SizedBox(
              width: 36,
              height: 36,
              child: ClipRRect(
                borderRadius: BorderRadius.circular(8),
                child: Container(
                  color: Colors.black26,
                  alignment: Alignment.center,
                  child: const Icon(Icons.auto_fix_high, color: Colors.cyanAccent),
                ),
              ),
            ),
            const SizedBox(width: 8),
            Expanded(
              child: Text(
                get('remove_bg_title', fallback: 'Eliminar fondo'),
                style: const TextStyle(fontSize: 14, fontWeight: FontWeight.w600),
              ),
            ),
            IconButton(
              tooltip: get('minimize', fallback: 'Minimizar'),
              icon: const Icon(Icons.remove, size: 18),
              onPressed: () async => await windowManager.minimize(),
            ),
            IconButton(
              tooltip: get('maximize', fallback: 'Maximizar'),
              icon: const Icon(Icons.crop_square, size: 18),
              onPressed: () async {
                final isMax = await windowManager.isMaximized();
                if (isMax) {
                  await windowManager.unmaximize();
                } else {
                  await windowManager.maximize();
                }
              },
            ),
            IconButton(
              tooltip: widget.getText('back', fallback: 'Back'),
              icon: const Icon(Icons.arrow_back, size: 18),
              onPressed: () => Navigator.of(context).maybePop(),
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final get = widget.getText;
    return Scaffold(
      backgroundColor: Colors.transparent,
      body: Column(
        children: [
          _buildTitleBar(),
          Expanded(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      ElevatedButton.icon(
                        icon: const Icon(Icons.image),
                        label: Text(get('select_image', fallback: 'Seleccionar imagen')),
                        onPressed: _pickImage,
                      ),
                      const SizedBox(width: 12),
                      ElevatedButton.icon(
                        icon: const Icon(Icons.auto_fix_high),
                        label: Text(get('remove_bg_button', fallback: 'Eliminar fondo')),
                        onPressed: _selectedImage != null ? _removeBackgroundLocally : null,
                      ),
                    ],
                  ),
                  const SizedBox(height: 24),
                  if (_processing)
                    const Center(child: CircularProgressIndicator())
                  else if (_resultImage != null)
                    Expanded(
                      child: Center(
                        child: ClipRRect(
                          borderRadius: BorderRadius.circular(12),
                          child: Image.memory(_resultImage!),
                        ),
                      ),
                    )
                  else if (_selectedImage != null)
                    Expanded(
                      child: Center(
                        child: ClipRRect(
                          borderRadius: BorderRadius.circular(12),
                          child: Image.file(_selectedImage!),
                        ),
                      ),
                    )
                  else
                    Expanded(
                      child: Center(
                        child: Text(get('no_image_selected', fallback: 'Ninguna imagen seleccionada')),
                      ),
                    ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}
