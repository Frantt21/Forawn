import 'dart:async';
import 'dart:convert';
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter/services.dart' show rootBundle;
import 'package:flutter_acrylic/flutter_acrylic.dart' as acrylic;
import 'package:forawn/screen/notes_screen.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:window_manager/window_manager.dart';
import 'screen/spotify_screen.dart';
import 'settings.dart';
import 'imgia_screen.dart';
import 'r34.dart';
import 'translate.dart';
import 'package:path/path.dart' as p;
import 'package:sqflite_common_ffi/sqflite_ffi.dart';
import 'services/download_manager.dart';
import 'version.dart';
import 'package:url_launcher/url_launcher.dart';
import 'widgets/fade_transition_screen.dart';
import 'screen/removebackground.dart';
import 'dart:typed_data';
import 'package:flutter/services.dart' show rootBundle;


const String kDefaultLangCode = 'en';
const _prefEffectKey = 'window_effect';
const _prefColorKey = 'window_color';
const _prefDarkKey = 'window_dark';


String currentLang = kDefaultLangCode;
Map<String, String> lang = {};
bool gNativeAcrylicAvailable = false;

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Inicialización FFI para sqflite en escritorio
  try {
    sqfliteFfiInit();
    databaseFactory = databaseFactoryFfi;
  } catch (_) {
    // No hacer nada si falla
  }

  // Inicializar flutter_acrylic
  try {
    await acrylic.Window.initialize();
    await acrylic.Window.hideWindowControls();
    gNativeAcrylicAvailable = true;
    final prefs = await SharedPreferences.getInstance();
    final savedEffect = prefs.getString(_prefEffectKey) ?? 'acrylic';
    final savedColor = Color(prefs.getInt(_prefColorKey) ?? 0xCC222222);
    final savedDark = prefs.getBool(_prefDarkKey) ?? true;
    await acrylic.Window.setEffect(
      effect: acrylic.WindowEffect.values.firstWhere((e) => e.name == savedEffect, orElse: () => acrylic.WindowEffect.acrylic),
      color: savedColor,
      dark: savedDark,
    );
  } catch (_) {
    gNativeAcrylicAvailable = false;
  }

  // Inicializar window_manager
  try {
    await windowManager.ensureInitialized();
    await DownloadManager().loadPersisted();
    await windowManager.setAsFrameless();
    final options = WindowOptions(
      size: const Size(1024, 600),
      center: true,
      title: 'Forawn',
    );
    windowManager.waitUntilReadyToShow(options, () async {
      await windowManager.setResizable(false);
      await windowManager.setMinimumSize(const Size(600, 420));
      await windowManager.show();
      await windowManager.focus();
    });
  } catch (_) {}

  // Cargar preferencia de idioma antes de runApp
  final prefs = await SharedPreferences.getInstance();
  final saved = prefs.getString('preferred_lang') ?? kDefaultLangCode;
  currentLang = saved;
  lang = await loadLanguageFromExeOrAssets(saved);

  runApp(ForawnAppRoot(initialLangCode: currentLang, initialLangMap: lang));
}

Future<Map<String, String>> loadLanguageFromExeOrAssets(String code) async {
  final Map<String, String> empty = <String, String>{};

  try {
    final base = _exeBaseDir();
    final external = File(p.join(base, 'lang', '$code.json'));
    if (await external.exists()) {
      final s = await external.readAsString();
      final Map<String, dynamic> parsed = jsonDecode(s);
      return parsed.map((k, v) => MapEntry(k, v.toString()));
    }
  } catch (_) {}

  try {
    final content = await rootBundle.loadString('lang/$code.json');
    final Map<String, dynamic> parsed = jsonDecode(content);
    return parsed.map((k, v) => MapEntry(k, v.toString()));
  } catch (_) {}

  return empty;
}

String _exeBaseDir() {
  try {
    final resolved = Platform.resolvedExecutable;
    if (resolved.isNotEmpty) return File(resolved).parent.path;
  } catch (_) {}
  try {
    return Directory.current.path;
  } catch (_) {}
  return '.';
}

Future<void> checkForUpdate(BuildContext context, String Function(String key, {String? fallback}) getText) async {
  const repoOwner = 'Frantt21';
  const repoName = 'Forawn';
  const apiUrl = 'https://api.github.com/repos/$repoOwner/$repoName/releases/latest';

  try {
    final client = HttpClient();
    final req = await client.getUrl(Uri.parse(apiUrl)).timeout(const Duration(seconds: 8));
    final res = await req.close().timeout(const Duration(seconds: 8));
    final body = await res.transform(utf8.decoder).join();
    client.close(force: true);

    if (res.statusCode != 200) return;

    final data = jsonDecode(body);
    final latestTag = data['tag_name']?.toString() ?? '';
    final releaseUrl = data['html_url']?.toString() ?? '';

    if (latestTag.isNotEmpty && latestTag != currentVersion) {
      if (!context.mounted) return;
      showDialog(
        context: context,
        builder: (_) => AlertDialog(
          title: Text(getText('update_title', fallback: 'Nueva versión disponible')),
          content: Text('${getText('update_current', fallback: 'Versión actual')}: $currentVersion\n${getText('update_latest', fallback: 'Última versión')}: $latestTag'),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: Text(getText('close_button', fallback: 'Cerrar')),
            ),
            ElevatedButton.icon(
              icon: const Icon(Icons.download),
              label: Text(getText('update_button', fallback: 'Actualizar')),
              onPressed: () async {
                Navigator.of(context).pop();
                await launchUrl(Uri.parse(releaseUrl), mode: LaunchMode.externalApplication);
              },
            ),
          ],
        ),
      );
    }
  } catch (e) {
    debugPrint('[UpdateCheck] error: $e');
  }
}

class ForawnAppRoot extends StatefulWidget {
  final String initialLangCode;
  final Map<String, String> initialLangMap;
  const ForawnAppRoot({super.key, required this.initialLangCode, required this.initialLangMap});

  @override
  State<ForawnAppRoot> createState() => _ForawnAppRootState();
}

class _ForawnAppRootState extends State<ForawnAppRoot> {
  late String _langCode;
  late Map<String, String> _langMap;

  @override
  void initState() {
    super.initState();
    _langCode = widget.initialLangCode;
    _langMap = widget.initialLangMap;
    _loadModelBytesAndOtherAsync();
  }

  Uint8List? _modelBytes; // campo del State

  Future<void> _loadModelBytesAndOtherAsync() async {
    try {
      final ByteData data = await rootBundle.load('assets/models/u2net.tflite');
      _modelBytes = data.buffer.asUint8List();
      debugPrint('Model bytes loaded, length: ${_modelBytes!.length}');
    } catch (e) {
      debugPrint('[ModelLoad] failed: $e');
      _modelBytes = null;
    }

    // Si necesitás hacer otras cargas async (por ejemplo idiomas), hacelo aquí
  }

  Future<void> _changeLanguage(String newCode) async {
    if (newCode == _langCode) return;
    final newMap = await loadLanguageFromExeOrAssets(newCode);
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('preferred_lang', newCode);
    if (!mounted) return;
    setState(() {
      _langCode = newCode;
      _langMap = newMap;
      currentLang = newCode;
      lang = Map<String, String>.from(newMap);
    });
  }

  String t(String key, {String? fallback}) => _langMap[key] ?? fallback ?? key;

  @override
  Widget build(BuildContext context) {
    return ClipRRect(
      borderRadius: BorderRadius.circular(0),
      child: MaterialApp(
        title: 'Forawn',
        theme: ThemeData.dark(useMaterial3: true).copyWith(
          appBarTheme: const AppBarTheme(
            backgroundColor: Colors.transparent,
            elevation: 0,
            surfaceTintColor: Colors.transparent,
            scrolledUnderElevation: 0,
          ),
        ),
        debugShowCheckedModeBanner: false,
        home: HomeScreen(getText: t, onRequestLanguageChange: _changeLanguage, currentLangCode: _langCode),
      ),
    );
  }
}

class HomeScreen extends StatefulWidget {
  final Future<void> Function(String) onRequestLanguageChange;
  final String currentLangCode;
  final String Function(String key, {String? fallback}) getText;

  const HomeScreen({super.key, required this.getText, required this.onRequestLanguageChange, required this.currentLangCode});
  

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> with WindowListener {
  final ValueNotifier<double> backgroundOpacity = ValueNotifier(1.0);
  final Map<String, bool?> _apiStatus = {
    'SpotifySearch ': null,
    'Spotify ': null,
    'Covers ': null,
    'Ai images ': null,
    'NFSW ': null,
  };
  Timer? _apiTimer;
  DateTime _now = DateTime.now();
  Timer? _clockTimer;
  bool _nsfwEnabled = false;

  Future<void> _applyWindowEffect(acrylic.WindowEffect effect, Color color, {bool dark = true}) async {
    try {
      final prefs = await SharedPreferences.getInstance();

      // Si vamos a aplicar transparente, primero desactivamos el efecto actual
      if (effect == acrylic.WindowEffect.transparent) {
        await acrylic.Window.setEffect(effect: acrylic.WindowEffect.disabled, color: Colors.transparent, dark: dark);
        await Future.delayed(const Duration(milliseconds: 50)); // pequeña pausa para asegurar limpieza
      }

      await acrylic.Window.setEffect(effect: effect, color: color, dark: dark);

      await prefs.setString(_prefEffectKey, effect.name);
      await prefs.setInt(_prefColorKey, color.value);
      await prefs.setBool(_prefDarkKey, dark);
    } catch (e) {
      debugPrint('[WindowEffect] error: $e');
    }
  }

  @override
  void initState() {
    super.initState();
    windowManager.addListener(this);
    _loadNsfwPref();
    _clockTimer = Timer.periodic(const Duration(seconds: 1), (_) {
      if (!mounted) return;
      setState(() => _now = DateTime.now());
    });
    _checkApis();
    _apiTimer = Timer.periodic(const Duration(minutes: 3), (_) {
      if (!mounted) return;
      _checkApis();
    });
    WidgetsBinding.instance.addPostFrameCallback((_) {
      checkForUpdate(context, widget.getText);
    });
  }

  Future<void> _loadNsfwPref() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final enabled = prefs.getBool('nsfw_enabled') ?? false;
      if (!mounted) return;
      setState(() => _nsfwEnabled = enabled);
    } catch (_) {}
  }

  @override
  void onWindowClose() {}

  Future<void> _checkApis() async {
    final apis = {
      'SpotifySearch ': 'https://api.dorratz.com/spotifysearch?query=test',
      'Spotify ': 'https://api.dorratz.com/spotifydl?url=https://open.spotify.com/track/1KSqYYJFyfTecXFk9M0prc',
      'Covers ': 'https://api.dorratz.com/v2/pinterest?q=test',
      'Ai images ': 'https://api.dorratz.com/v3/ai-image?prompt=cat+gris&ratio=9:19',
      'NFSW ': 'https://api.dorratz.com/v2/rule34-s?q=Bulma%20dbz',
    };

    for (final entry in apis.entries) {
      try {
        final uri = Uri.parse(entry.value);
        final client = HttpClient();
        final req = await client.getUrl(uri).timeout(const Duration(seconds: 6));
        final res = await req.close().timeout(const Duration(seconds: 6));
        final ok = res.statusCode >= 200 && res.statusCode < 400;
        client.close(force: true);
        if (!mounted) return;
        setState(() => _apiStatus[entry.key] = ok);
      } catch (_) {
        if (!mounted) return;
        setState(() => _apiStatus[entry.key] = false);
      }
    }
  }

  @override
  void dispose() {
    _apiTimer?.cancel();
    _clockTimer?.cancel();
    windowManager.removeListener(this);
    super.dispose();
  }

  Widget glassCard({required Widget child, double radius = 12, double alpha = 0.03}) {
    final bgColor = gNativeAcrylicAvailable
        ? Colors.black.withAlpha((alpha * 255).round())
        : Colors.grey.withAlpha((0.06 * 255).round());
    final borderColor = Colors.white.withAlpha((0.06 * 255).round());
    return ClipRRect(
      borderRadius: BorderRadius.circular(radius),
      child: Container(
        decoration: BoxDecoration(
          color: bgColor,
          borderRadius: BorderRadius.circular(radius),
          border: Border.all(color: borderColor),
        ),
        child: child,
      ),
    );
  }

  Widget _windowButtons() {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        IconButton(
          tooltip: widget.getText('minimize', fallback: 'Minimize'),
          icon: const Icon(Icons.remove, size: 18),
          onPressed: () => windowManager.minimize(),
        ),
        IconButton(
          tooltip: widget.getText('maximize', fallback: 'Maximize'),
          icon: const Icon(Icons.crop_square, size: 18),
          onPressed: () async {
            final isMax = await windowManager.isMaximized();
            if (isMax) {
              await windowManager.unmaximize();
            } else {
              await windowManager.maximize();
            }
          },
        ),
        IconButton(
          tooltip: widget.getText('back', fallback: 'Back'),
          icon: const Icon(Icons.close, size: 18),
          onPressed: () => windowManager.close(),
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    final bool native = gNativeAcrylicAvailable;

    final Color scaffoldBg = Colors.transparent;
    final bool extendBehindAppBar = !native;

    final timeStr = '${_now.hour.toString().padLeft(2, '0')}:${_now.minute.toString().padLeft(2, '0')}';
    final dateStr = '${_now.day}/${_now.month}/${_now.year}';

    return Scaffold(
      backgroundColor: scaffoldBg,
      extendBodyBehindAppBar: extendBehindAppBar,
      body: ValueListenableBuilder<double>(
        valueListenable: backgroundOpacity,
        builder: (_, opacity, __) {
          return Opacity(
            opacity: opacity,
            child: Column(
              children: [
                GestureDetector(
                  behavior: HitTestBehavior.translucent,
                  onPanStart: (_) => windowManager.startDragging(),
                  child: Container(
                    height: 42,
                    padding: const EdgeInsets.symmetric(horizontal: 10),
                    color: Colors.transparent,
                    child: Row(
                      children: [
                        SizedBox(
                          width: 36,
                          height: 36,
                          child: ClipRRect(
                            borderRadius: BorderRadius.circular(8),
                            child: Container(
                              color: Colors.black26,
                              alignment: Alignment.center,
                              child: const Icon(Icons.flash_on, color: Colors.purpleAccent),
                            ),
                          ),
                        ),
                        const SizedBox(width: 8),
                        Expanded(
                          child: Text(
                            widget.getText('title', fallback: 'Forawn'),
                            style: const TextStyle(fontSize: 14, fontWeight: FontWeight.w600),
                          ),
                        ),
                        IconButton(
                          tooltip: widget.getText('setting_tittle', fallback: 'Settings'),
                          icon: const Icon(Icons.settings),
                          onPressed: () async {
                            backgroundOpacity.value = 0.0;

                            final selected = await Navigator.of(context).push<String?>(
                              PageRouteBuilder(
                                opaque: false,
                                barrierColor: Colors.transparent,
                                transitionDuration: const Duration(milliseconds: 400),
                                pageBuilder: (_, __, ___) => FadeTransitionScreen(
                                  child: SettingsScreen(
                                    currentLang: widget.currentLangCode,
                                    getText: widget.getText,
                                    onSelectLanguage: (code) async => await widget.onRequestLanguageChange(code),
                                    onChangeWindowEffect: _applyWindowEffect,
                                  ),
                                ),
                                transitionsBuilder: (_, animation, __, child) {
                                  return FadeTransition(
                                    opacity: animation,
                                    child: child,
                                  );
                                },
                              ),
                            );
                            backgroundOpacity.value = 1.0;
                            if (!mounted) return;
                            setState(() {}); // fuerza reconstrucción para limpiar visual
                            if (selected != null) await widget.onRequestLanguageChange(selected);
                            await _loadNsfwPref();
                          },

                        ),
                        _windowButtons(),
                      ],
                    ),
                  ),
                ),

                Expanded(
                  child: SafeArea(
                    child: Center(
                      child: Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 18),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Column(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Text(timeStr, style: const TextStyle(fontSize: 32, fontWeight: FontWeight.bold)),
                                const SizedBox(height: 4),
                                Text(dateStr, style: const TextStyle(fontSize: 14)),
                              ],
                            ),
                            const SizedBox(height: 28),
                            Center(
                              child: Wrap(
                                spacing: 12,
                                runSpacing: 12,
                                alignment: WrapAlignment.center,
                                children: [
                                  ElevatedButton.icon(
                                    icon: const Icon(Icons.download),
                                    label: Text(widget.getText('download_button', fallback: 'Musica')),
                                    onPressed: () async {
                                      backgroundOpacity.value = 0.0;
                                      await Navigator.of(context).push(PageRouteBuilder(
                                        opaque: false,
                                        barrierColor: Colors.transparent,
                                        transitionDuration: const Duration(milliseconds: 400),
                                        pageBuilder: (_, __, ___) => FadeTransitionScreen(
                                          child: SpotifyScreen(
                                            getText: widget.getText,
                                            currentLang: widget.currentLangCode,
                                          ),
                                        ),
                                        transitionsBuilder: (_, animation, __, child) {
                                          return FadeTransition(
                                            opacity: animation,
                                            child: child,
                                          );
                                        },
                                      ));
                                      backgroundOpacity.value = 1.0;
                                    },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: Colors.transparent,
                                      foregroundColor: Colors.white,
                                      shadowColor: Colors.transparent,
                                      elevation: 0,
                                      padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 12),
                                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                                      side: const BorderSide(color: Colors.white, width: 1),
                                    ).merge(
                                      ButtonStyle(
                                        overlayColor: WidgetStateProperty.resolveWith<Color?>((states) {
                                          if (states.contains(WidgetState.pressed)) return Colors.white.withOpacity(0.10);
                                          if (states.contains(WidgetState.hovered)) return Colors.white.withOpacity(0.06);
                                          if (states.contains(WidgetState.focused)) return Colors.white.withOpacity(0.06);
                                          return null;
                                        }),
                                      ),
                                    ),
                                  ),
                                  ElevatedButton.icon(
                                    icon: const Icon(Icons.image),
                                    label: Text(widget.getText('ai_image_title', fallback: 'Imagenes')),
                                    onPressed: () async {
                                      backgroundOpacity.value = 0.0;
                                      await Navigator.of(context).push(PageRouteBuilder(
                                        opaque: false,
                                        barrierColor: Colors.transparent,
                                        transitionDuration: const Duration(milliseconds: 400),
                                        pageBuilder: (_, __, ___) => FadeTransitionScreen(
                                          child: AiImageScreen(
                                            getText: widget.getText,
                                            currentLang: widget.currentLangCode,
                                          ),
                                        ),
                                        transitionsBuilder: (_, animation, __, child) {
                                          return FadeTransition(
                                            opacity: animation,
                                            child: child,
                                          );
                                        },
                                      ));
                                      backgroundOpacity.value = 1.0;
                                    },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: Colors.transparent,
                                      foregroundColor: Colors.white,
                                      shadowColor: Colors.transparent,
                                      elevation: 0,
                                      padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 12),
                                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                                      side: const BorderSide(color: Colors.white, width: 1),
                                    ).merge(
                                      ButtonStyle(
                                        overlayColor: WidgetStateProperty.resolveWith<Color?>((states) {
                                          if (states.contains(WidgetState.pressed)) return Colors.white.withOpacity(0.10);
                                          if (states.contains(WidgetState.hovered)) return Colors.white.withOpacity(0.06);
                                          if (states.contains(WidgetState.focused)) return Colors.white.withOpacity(0.06);
                                          return null;
                                        }),
                                      ),
                                    ),
                                  ),
                                  ElevatedButton.icon(
                                    icon: const Icon(Icons.translate),
                                    label: Text(widget.getText('translate_title', fallback: 'Traductor')),
                                    onPressed: () async {
                                      backgroundOpacity.value = 0.0;
                                      await Navigator.of(context).push(PageRouteBuilder(
                                        opaque: false,
                                        barrierColor: Colors.transparent,
                                        transitionDuration: const Duration(milliseconds: 400),
                                        pageBuilder: (_, __, ___) => FadeTransitionScreen(
                                          child: TranslateScreen(
                                            getText: widget.getText,
                                            currentLang: widget.currentLangCode,
                                          ),
                                        ),
                                        transitionsBuilder: (_, animation, __, child) {
                                          return FadeTransition(
                                            opacity: animation,
                                            child: child,
                                          );
                                        },
                                      ));
                                      backgroundOpacity.value = 1.0;
                                    },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: Colors.transparent,
                                      foregroundColor: Colors.white,
                                      shadowColor: Colors.transparent,
                                      elevation: 0,
                                      padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 12),
                                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                                      side: const BorderSide(color: Colors.white, width: 1),
                                    ).merge(
                                      ButtonStyle(
                                        overlayColor: WidgetStateProperty.resolveWith<Color?>((states) {
                                          if (states.contains(WidgetState.pressed)) return Colors.white.withOpacity(0.10);
                                          if (states.contains(WidgetState.hovered)) return Colors.white.withOpacity(0.06);
                                          if (states.contains(WidgetState.focused)) return Colors.white.withOpacity(0.06);
                                          return null;
                                        }),
                                      ),
                                    ),
                                  ),
                                  ElevatedButton.icon(
                                    icon: const Icon(Icons.download),
                                    label: Text(widget.getText('remove_bg', fallback: 'Remove Background')),
                                    onPressed: () async {
                                      backgroundOpacity.value = 0.0;
                                      await Navigator.of(context).push(PageRouteBuilder(
                                        opaque: false,
                                        barrierColor: Colors.transparent,
                                        transitionDuration: const Duration(milliseconds: 400),
                                        pageBuilder: (_, __, ___) => FadeTransitionScreen(
                                          child: BackgroundRemoverScreen(
                                            getText: widget.getText,
                                          ),
                                        ),
                                        transitionsBuilder: (_, animation, __, child) {
                                          return FadeTransition(
                                            opacity: animation,
                                            child: child,
                                          );
                                        },
                                      ));
                                      backgroundOpacity.value = 1.0;
                                    },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: Colors.transparent,
                                      foregroundColor: Colors.white,
                                      shadowColor: Colors.transparent,
                                      elevation: 0,
                                      padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 12),
                                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                                      side: const BorderSide(color: Colors.white, width: 1),
                                    ).merge(
                                      ButtonStyle(
                                        overlayColor: WidgetStateProperty.resolveWith<Color?>((states) {
                                          if (states.contains(WidgetState.pressed)) return Colors.white.withOpacity(0.10);
                                          if (states.contains(WidgetState.hovered)) return Colors.white.withOpacity(0.06);
                                          if (states.contains(WidgetState.focused)) return Colors.white.withOpacity(0.06);
                                          return null;
                                        }),
                                      ),
                                    ), 
                                  ),
                                  ElevatedButton.icon(
                                    icon: const Icon(Icons.note),
                                    label: Text(widget.getText('notes_title', fallback: 'Notas')),
                                    onPressed: () async {
                                      backgroundOpacity.value = 0.0;
                                      await Navigator.of(context).push(PageRouteBuilder(
                                        opaque: false,
                                        barrierColor: Colors.transparent,
                                        transitionDuration: const Duration(milliseconds: 400),
                                        pageBuilder: (_, __, ___) => FadeTransitionScreen(
                                          child: NotesScreen(
                                            getText: widget.getText,
                                            currentLang: widget.currentLangCode,
                                          ),
                                        ),
                                        transitionsBuilder: (_, animation, __, child) {
                                          return FadeTransition(
                                            opacity: animation,
                                            child: child,
                                          );
                                        },
                                      ));
                                      backgroundOpacity.value = 1.0;
                                    },
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: Colors.transparent,
                                      foregroundColor: Colors.white,
                                      shadowColor: Colors.transparent,
                                      elevation: 0,
                                      padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 12),
                                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                                      side: const BorderSide(color: Colors.white, width: 1),
                                    ).merge(
                                      ButtonStyle(
                                        overlayColor: WidgetStateProperty.resolveWith<Color?>((states) {
                                          if (states.contains(WidgetState.pressed)) return Colors.white.withOpacity(0.10);
                                          if (states.contains(WidgetState.hovered)) return Colors.white.withOpacity(0.06);
                                          if (states.contains(WidgetState.focused)) return Colors.white.withOpacity(0.06);
                                          return null;
                                        }),
                                      ),
                                    ),
                                  ),
                                  if (_nsfwEnabled)
                                    ElevatedButton.icon(
                                      icon: const Icon(Icons.image_search),
                                      label: Text(widget.getText('r34_title', fallback: 'R34 Buscador')),
                                    onPressed: () async {
                                      backgroundOpacity.value = 0.0;
                                      await Navigator.of(context).push(PageRouteBuilder(
                                        opaque: false,
                                        barrierColor: Colors.transparent,
                                        transitionDuration: const Duration(milliseconds: 400),
                                        pageBuilder: (_, __, ___) => FadeTransitionScreen(
                                          child: R34Screen(
                                            getText: widget.getText,
                                            currentLang: widget.currentLangCode,
                                          ),
                                        ),
                                        transitionsBuilder: (_, animation, __, child) {
                                          return FadeTransition(
                                            opacity: animation,
                                            child: child,
                                          );
                                        },
                                      ));
                                      backgroundOpacity.value = 1.0;
                                    },
                                      style: ElevatedButton.styleFrom(
                                        backgroundColor: Colors.transparent,
                                        foregroundColor: Colors.white,
                                        shadowColor: Colors.transparent,
                                        elevation: 0,
                                        padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 12),
                                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                                        side: const BorderSide(color: Colors.white, width: 1),
                                      ).merge(
                                        ButtonStyle(
                                          overlayColor: WidgetStateProperty.resolveWith<Color?>((states) {
                                            if (states.contains(WidgetState.pressed)) return Colors.white.withOpacity(0.10);
                                            if (states.contains(WidgetState.hovered)) return Colors.white.withOpacity(0.06);
                                            if (states.contains(WidgetState.focused)) return Colors.white.withOpacity(0.06);
                                            return null;
                                          }),
                                        ),
                                      ),
                                    ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ),

                Padding(
                  padding: const EdgeInsets.fromLTRB(0, 0, 12, 12),
                  child: Row(
                    children: [
                      const Spacer(),
                      glassCard(
                        radius: 12,
                        alpha: native ? 0.03 : 0.06,
                        child: Padding(
                          padding: const EdgeInsets.all(12),
                          child: Column(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Text(widget.getText('api_status', fallback: 'Estado de APIs'),
                                  style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                              const SizedBox(height: 8),
                              Column(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  for (final entry in _apiStatus.entries)
                                    Padding(
                                      padding: const EdgeInsets.symmetric(vertical: 2),
                                      child: Row(
                                        mainAxisSize: MainAxisSize.min,
                                        children: [
                                          Text(entry.key, style: const TextStyle(fontSize: 12)),
                                          const SizedBox(width: 8),
                                          Icon(
                                            entry.value == true ? Icons.check_circle : (entry.value == false ? Icons.cancel : Icons.help_outline),
                                            color: entry.value == true ? Colors.green : (entry.value == false ? Colors.red : Colors.amber),
                                            size: 16,
                                          ),
                                        ],
                                      ),
                                    ),
                                ],
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}
